# Create clk_wiz
cell xilinx.com:ip:clk_wiz pll_0 {
  PRIMITIVE PLL
  PRIM_IN_FREQ.VALUE_SRC USER
  PRIM_IN_FREQ 122.88
  PRIM_SOURCE Differential_clock_capable_pin
  CLKOUT1_USED true
  CLKOUT1_REQUESTED_OUT_FREQ 122.88
  CLKOUT2_USED true
  CLKOUT2_REQUESTED_OUT_FREQ 245.76
  CLKOUT2_REQUESTED_PHASE 157.5
  CLKOUT3_USED true
  CLKOUT3_REQUESTED_OUT_FREQ 245.76
  CLKOUT3_REQUESTED_PHASE 202.5
  USE_RESET false
} {
  clk_in1_p adc_clk_p_i
  clk_in1_n adc_clk_n_i
}

# Create processing_system7
cell xilinx.com:ip:processing_system7 ps_0 {
  PCW_IMPORT_BOARD_PRESET cfg/red_pitaya.xml
  PCW_USE_S_AXI_ACP 1
  PCW_USE_DEFAULT_ACP_USER_VAL 1
} {
  M_AXI_GP0_ACLK pll_0/clk_out1
  S_AXI_ACP_ACLK pll_0/clk_out1
}

# Create all required interconnections
apply_bd_automation -rule xilinx.com:bd_rule:processing_system7 -config {
  make_external {FIXED_IO, DDR}
  Master Disable
  Slave Disable
} [get_bd_cells ps_0]

# Create xlconstant
cell xilinx.com:ip:xlconstant const_0

# Create proc_sys_reset
cell xilinx.com:ip:proc_sys_reset rst_0 {} {
  ext_reset_in const_0/dout
  dcm_locked pll_0/locked
  slowest_sync_clk pll_0/clk_out1
}

# ADC

# Create axis_red_pitaya_adc
cell pavel-demin:user:axis_red_pitaya_adc adc_0 {
  ADC_DATA_WIDTH 16
} {
  aclk pll_0/clk_out1
  adc_dat_a adc_dat_a_i
  adc_dat_b adc_dat_b_i
  adc_csn adc_csn_o
}

# DAC

# Create axis_red_pitaya_dac
cell pavel-demin:user:axis_red_pitaya_dac dac_0 {
  DAC_DATA_WIDTH 14
} {
  aclk pll_0/clk_out1
  ddr_clk pll_0/clk_out2
  wrt_clk pll_0/clk_out3
  locked pll_0/locked
  dac_clk dac_clk_o
  dac_rst dac_rst_o
  dac_sel dac_sel_o
  dac_wrt dac_wrt_o
  dac_dat dac_dat_o
  s_axis_tvalid const_0/dout
}

# HUB

# Create axi_hub
cell pavel-demin:user:axi_hub hub_0 {
  CFG_DATA_WIDTH 224
  STS_DATA_WIDTH 32
} {
  S_AXI ps_0/M_AXI_GP0
  aclk pll_0/clk_out1
  aresetn rst_0/peripheral_aresetn
}

# Create port_slicer
cell pavel-demin:user:port_slicer slice_0 {
  DIN_WIDTH 224 DIN_FROM 0 DIN_TO 0
} {
  din hub_0/cfg_data
}

# Create port_slicer
cell pavel-demin:user:port_slicer slice_1 {
  DIN_WIDTH 224 DIN_FROM 1 DIN_TO 1
} {
  din hub_0/cfg_data
}

# Create port_slicer
cell pavel-demin:user:port_slicer slice_2 {
  DIN_WIDTH 224 DIN_FROM 31 DIN_TO 16
} {
  din hub_0/cfg_data
}

# Create port_slicer
cell pavel-demin:user:port_slicer slice_3 {
  DIN_WIDTH 224 DIN_FROM 63 DIN_TO 32
} {
  din hub_0/cfg_data
}

# DDS

for {set i 0} {$i <= 3} {incr i} {

  # Create port_slicer
  cell pavel-demin:user:port_slicer slice_[expr $i + 4] {
    DIN_WIDTH 224 DIN_FROM [expr 32 * $i + 95] DIN_TO [expr 32 * $i + 64]
  } {
    din hub_0/cfg_data
  }

  # Create axis_constant
  cell pavel-demin:user:axis_constant phase_$i {
    AXIS_TDATA_WIDTH 32
  } {
    cfg_data slice_[expr $i + 4]/dout
    aclk pll_0/clk_out1
  }

  # Create dds_compiler
  cell xilinx.com:ip:dds_compiler dds_$i {
    DDS_CLOCK_RATE 122.88
    SPURIOUS_FREE_DYNAMIC_RANGE 138
    FREQUENCY_RESOLUTION 0.2
    PHASE_INCREMENT Streaming
    HAS_PHASE_OUT false
    PHASE_WIDTH 30
    OUTPUT_WIDTH 24
    DSP48_USE Minimal
    NEGATIVE_SINE true
  } {
    S_AXIS_PHASE phase_$i/M_AXIS
    aclk pll_0/clk_out1
  }

}

# RX

for {set i 0} {$i <= 3} {incr i} {

  # Create port_slicer
  cell pavel-demin:user:port_slicer adc_slice_$i {
    DIN_WIDTH 32 DIN_FROM [expr 16 * ($i / 2) + 15] DIN_TO [expr 16 * ($i / 2)]
  } {
    din adc_0/m_axis_tdata
  }

  # Create port_slicer
  cell pavel-demin:user:port_slicer dds_slice_$i {
    DIN_WIDTH 48 DIN_FROM [expr 24 * ($i % 2) + 23] DIN_TO [expr 24 * ($i % 2)]
  } {
    din dds_[expr $i / 2]/m_axis_data_tdata
  }

  # Create dsp48
  cell pavel-demin:user:dsp48 mult_$i {
    A_WIDTH 24
    B_WIDTH 16
    P_WIDTH 24
  } {
    A dds_slice_$i/dout
    B adc_slice_$i/dout
    CLK pll_0/clk_out1
  }

  # Create axis_variable
  cell pavel-demin:user:axis_variable rate_$i {
    AXIS_TDATA_WIDTH 16
  } {
    cfg_data slice_2/dout
    aclk pll_0/clk_out1
    aresetn slice_0/dout
  }

  # Create cic_compiler
  cell xilinx.com:ip:cic_compiler cic_$i {
    INPUT_DATA_WIDTH.VALUE_SRC USER
    FILTER_TYPE Decimation
    NUMBER_OF_STAGES 6
    SAMPLE_RATE_CHANGES Programmable
    MINIMUM_RATE 6
    MAXIMUM_RATE 64
    FIXED_OR_INITIAL_RATE 6
    INPUT_SAMPLE_FREQUENCY 122.88
    CLOCK_FREQUENCY 122.88
    INPUT_DATA_WIDTH 24
    QUANTIZATION Truncation
    OUTPUT_DATA_WIDTH 32
    USE_XTREME_DSP_SLICE false
    HAS_ARESETN true
  } {
    s_axis_data_tdata mult_$i/P
    s_axis_data_tvalid const_0/dout
    S_AXIS_CONFIG rate_$i/M_AXIS
    aclk pll_0/clk_out1
    aresetn slice_0/dout
  }

}

# Create axis_combiner
cell  xilinx.com:ip:axis_combiner comb_0 {
  TDATA_NUM_BYTES.VALUE_SRC USER
  TDATA_NUM_BYTES 4
  NUM_SI 4
} {
  S00_AXIS cic_0/M_AXIS_DATA
  S01_AXIS cic_1/M_AXIS_DATA
  S02_AXIS cic_2/M_AXIS_DATA
  S03_AXIS cic_3/M_AXIS_DATA
  aclk pll_0/clk_out1
  aresetn slice_0/dout
}

# Create fir_compiler
cell xilinx.com:ip:fir_compiler fir_0 {
  DATA_WIDTH.VALUE_SRC USER
  DATA_WIDTH 32
  COEFFICIENTVECTOR {-2.5860259477e-08, -1.4214822340e-08, 2.3258106116e-08, 9.5759824568e-09, -1.1853225758e-08, 3.8608390690e-09, -1.0934610042e-08, -3.0243695455e-08, 4.7695601595e-08, 7.4614327927e-08, -1.0092642370e-07, -1.4296114009e-07, 1.7285909953e-07, 2.4220897409e-07, -2.6528572712e-07, -3.8017683958e-07, 3.7935643009e-07, 5.6547089428e-07, -5.1538462483e-07, -8.0733477580e-07, 6.7264116740e-07, 1.1154292229e-06, -8.4916627226e-07, -1.4995559444e-06, 1.0415870157e-06, 1.9692938207e-06, -1.2449852254e-06, -2.5335782107e-06, 1.4527888413e-06, 3.2001299775e-06, -1.6569422667e-06, -3.9752447387e-06, 1.8475008610e-06, 4.8626955963e-06, -2.0132097867e-06, -5.8634009094e-06, 2.1415778550e-06, 6.9746839257e-06, -2.2192684175e-06, -8.1896267465e-06, 2.2325412855e-06, 9.4963546322e-06, -2.1679221441e-06, -1.0877449610e-05, 2.0129370543e-06, 1.2309381304e-05, -1.7570234030e-06, -1.3762088689e-05, 1.3924908410e-06, 1.5198597589e-05, -9.1567686872e-07, -1.6574854698e-05, 3.2808301913e-07, 1.7839338668e-05, 3.6133050031e-07, -1.8935020773e-05, -1.1371291124e-06, 1.9797304981e-05, 1.9737868751e-06, -2.0356407124e-05, -2.8352761480e-06, 2.0538033260e-05, 3.6737286695e-06, -2.0264804236e-05, -4.4284883268e-06, 1.9457724790e-05, 5.0250619666e-06, -1.8038242472e-05, -5.3745605053e-06, 1.5930428754e-05, 5.3733301497e-06, -1.3063584104e-05, -4.9032054151e-06, 9.3747884721e-06, 3.8319823546e-06, -4.8117778307e-06, -2.0147678435e-06, -6.6550596043e-07, -7.0798373351e-07, 7.0756658526e-06, 4.4998400620e-06, -1.4422093497e-05, -9.5338158165e-06, 2.2684153431e-05, 1.5985556792e-05, -3.1815865145e-05, -2.4029499459e-05, 4.1743466829e-05, 3.3833741349e-05, -5.2363995344e-05, -4.5554947842e-05, 6.3543759997e-05, 5.9332109823e-05, -7.5117895715e-05, -7.5280066774e-05, 8.6890352244e-05, 9.3482021262e-05, -9.8635446101e-05, -1.1398216278e-04, 1.1010019447e-04, 1.3677711736e-04, -1.2101195210e-04, -1.6181878546e-04, 1.3106437622e-04, 1.8898129028e-04, -1.3995109534e-04, -2.1807842494e-04, 1.4735483975e-04, 2.4884650314e-04, -1.5295985804e-04, -2.8093872476e-04, 1.5646156763e-04, 3.1391905581e-04, -1.5757838269e-04, -3.4725831674e-04, 1.5606346672e-04, 3.8033042383e-04, -1.5171833832e-04, -4.1241060061e-04, 1.4440676629e-04, 4.4267410591e-04, -1.3407071739e-04, -4.7019740211e-04, 1.2074686155e-04, 4.9395913714e-04, -1.0459455536e-04, -5.1287407375e-04, 8.5862113042e-05, 5.2573143521e-04, -6.4979562120e-05, -5.3127249271e-04, 4.2525987527e-05, 5.2817453745e-04, -1.9256562827e-05, -5.1506663737e-04, -3.8816170485e-06, 4.9054503986e-04, 2.5733607909e-05, -4.5319219978e-04, -4.4923821290e-05, 4.0159586796e-04, 5.9843284013e-05, -3.3437066723e-04, -6.8639409453e-05, 2.5017920209e-04, 6.9205257841e-05, -1.4775471378e-04, -5.9169204494e-05, 2.5920080511e-05, 3.5857429588e-05, 1.1631080819e-04, 3.5774440150e-06, -2.7989236452e-04, -6.2365086969e-05, 4.6553980382e-04, 1.4399020001e-04, -6.7377950449e-04, -2.5222726997e-04, 9.0492106729e-04, 3.9114951231e-04, -1.1590352728e-03, -5.6514037035e-04, 1.4359321859e-03, 7.7890638001e-04, -1.7351437713e-03, -1.0374979369e-03, 2.0559074748e-03, 1.3463372120e-03, -2.3971549727e-03, -1.7112609327e-03, 2.7575049291e-03, 2.1385858484e-03, -3.1352679599e-03, -2.6352789889e-03, 3.5282108578e-03, 3.2086681696e-03, -3.9340964827e-03, -3.8671998063e-03, 4.3501277323e-03, 4.6202487980e-03, -4.7731569979e-03, -5.4784863354e-03, 5.1996517576e-03, 6.4542706620e-03, -5.6256580492e-03, -7.5621757136e-03, 6.0467450242e-03, 8.8197193692e-03, -6.4579209517e-03, -1.0248386919e-02, 6.8534961963e-03, 1.1875084254e-02, -7.2268676390e-03, -1.3734246507e-02, 7.5701814152e-03, 1.5870997056e-02, -7.8737953507e-03, -1.8346302323e-02, 8.1241887923e-03, 2.1242501484e-02, -8.3047481093e-03, -2.4678182487e-02, 8.3899061751e-03, 2.8826622621e-02, -8.3399037408e-03, -3.3952339366e-02, 8.0878374300e-03, 4.0479492550e-02, -7.5110336578e-03, -4.9131506406e-02, 6.3606180211e-03, 6.1245470742e-02, -4.0625789820e-03, -7.9577336325e-02, -9.6154434906e-04, 1.1076254358e-01, 1.4363927952e-02, -1.7500435538e-01, -6.7844148863e-02, 3.5962587827e-01, 6.1140946911e-01, 3.5962587827e-01, -6.7844148863e-02, -1.7500435538e-01, 1.4363927952e-02, 1.1076254358e-01, -9.6154434906e-04, -7.9577336325e-02, -4.0625789820e-03, 6.1245470742e-02, 6.3606180211e-03, -4.9131506406e-02, -7.5110336578e-03, 4.0479492550e-02, 8.0878374300e-03, -3.3952339366e-02, -8.3399037408e-03, 2.8826622621e-02, 8.3899061751e-03, -2.4678182487e-02, -8.3047481093e-03, 2.1242501484e-02, 8.1241887923e-03, -1.8346302323e-02, -7.8737953507e-03, 1.5870997056e-02, 7.5701814152e-03, -1.3734246507e-02, -7.2268676390e-03, 1.1875084254e-02, 6.8534961963e-03, -1.0248386919e-02, -6.4579209517e-03, 8.8197193692e-03, 6.0467450242e-03, -7.5621757136e-03, -5.6256580492e-03, 6.4542706620e-03, 5.1996517576e-03, -5.4784863354e-03, -4.7731569979e-03, 4.6202487980e-03, 4.3501277323e-03, -3.8671998063e-03, -3.9340964827e-03, 3.2086681696e-03, 3.5282108578e-03, -2.6352789889e-03, -3.1352679599e-03, 2.1385858484e-03, 2.7575049291e-03, -1.7112609327e-03, -2.3971549727e-03, 1.3463372120e-03, 2.0559074748e-03, -1.0374979369e-03, -1.7351437713e-03, 7.7890638001e-04, 1.4359321859e-03, -5.6514037035e-04, -1.1590352728e-03, 3.9114951231e-04, 9.0492106729e-04, -2.5222726997e-04, -6.7377950449e-04, 1.4399020001e-04, 4.6553980382e-04, -6.2365086969e-05, -2.7989236452e-04, 3.5774440150e-06, 1.1631080819e-04, 3.5857429588e-05, 2.5920080511e-05, -5.9169204493e-05, -1.4775471378e-04, 6.9205257841e-05, 2.5017920209e-04, -6.8639409453e-05, -3.3437066723e-04, 5.9843284013e-05, 4.0159586796e-04, -4.4923821290e-05, -4.5319219978e-04, 2.5733607909e-05, 4.9054503986e-04, -3.8816170485e-06, -5.1506663737e-04, -1.9256562827e-05, 5.2817453745e-04, 4.2525987527e-05, -5.3127249271e-04, -6.4979562120e-05, 5.2573143521e-04, 8.5862113042e-05, -5.1287407375e-04, -1.0459455536e-04, 4.9395913714e-04, 1.2074686155e-04, -4.7019740211e-04, -1.3407071739e-04, 4.4267410591e-04, 1.4440676629e-04, -4.1241060061e-04, -1.5171833832e-04, 3.8033042383e-04, 1.5606346672e-04, -3.4725831674e-04, -1.5757838269e-04, 3.1391905581e-04, 1.5646156763e-04, -2.8093872476e-04, -1.5295985804e-04, 2.4884650314e-04, 1.4735483975e-04, -2.1807842494e-04, -1.3995109534e-04, 1.8898129028e-04, 1.3106437622e-04, -1.6181878546e-04, -1.2101195210e-04, 1.3677711736e-04, 1.1010019447e-04, -1.1398216278e-04, -9.8635446101e-05, 9.3482021262e-05, 8.6890352244e-05, -7.5280066774e-05, -7.5117895715e-05, 5.9332109823e-05, 6.3543759997e-05, -4.5554947842e-05, -5.2363995344e-05, 3.3833741349e-05, 4.1743466829e-05, -2.4029499459e-05, -3.1815865145e-05, 1.5985556792e-05, 2.2684153431e-05, -9.5338158165e-06, -1.4422093497e-05, 4.4998400620e-06, 7.0756658526e-06, -7.0798373351e-07, -6.6550596042e-07, -2.0147678435e-06, -4.8117778307e-06, 3.8319823546e-06, 9.3747884721e-06, -4.9032054151e-06, -1.3063584104e-05, 5.3733301497e-06, 1.5930428754e-05, -5.3745605053e-06, -1.8038242472e-05, 5.0250619666e-06, 1.9457724790e-05, -4.4284883268e-06, -2.0264804236e-05, 3.6737286695e-06, 2.0538033260e-05, -2.8352761480e-06, -2.0356407124e-05, 1.9737868751e-06, 1.9797304981e-05, -1.1371291124e-06, -1.8935020773e-05, 3.6133050031e-07, 1.7839338668e-05, 3.2808301913e-07, -1.6574854698e-05, -9.1567686872e-07, 1.5198597589e-05, 1.3924908410e-06, -1.3762088689e-05, -1.7570234030e-06, 1.2309381304e-05, 2.0129370543e-06, -1.0877449610e-05, -2.1679221441e-06, 9.4963546322e-06, 2.2325412855e-06, -8.1896267465e-06, -2.2192684175e-06, 6.9746839257e-06, 2.1415778550e-06, -5.8634009094e-06, -2.0132097867e-06, 4.8626955963e-06, 1.8475008610e-06, -3.9752447387e-06, -1.6569422667e-06, 3.2001299775e-06, 1.4527888413e-06, -2.5335782107e-06, -1.2449852254e-06, 1.9692938207e-06, 1.0415870157e-06, -1.4995559444e-06, -8.4916627226e-07, 1.1154292229e-06, 6.7264116740e-07, -8.0733477580e-07, -5.1538462483e-07, 5.6547089428e-07, 3.7935643009e-07, -3.8017683958e-07, -2.6528572712e-07, 2.4220897409e-07, 1.7285909953e-07, -1.4296114009e-07, -1.0092642370e-07, 7.4614327927e-08, 4.7695601595e-08, -3.0243695455e-08, -1.0934610042e-08, 3.8608390690e-09, -1.1853225758e-08, 9.5759824568e-09, 2.3258106116e-08, -1.4214822340e-08, -2.5860259477e-08}
  COEFFICIENT_WIDTH 24
  QUANTIZATION Quantize_Only
  BESTPRECISION true
  FILTER_TYPE Decimation
  DECIMATION_RATE 2
  NUMBER_CHANNELS 1
  NUMBER_PATHS 4
  SAMPLE_FREQUENCY 20.48
  CLOCK_FREQUENCY 122.88
  OUTPUT_ROUNDING_MODE Convergent_Rounding_to_Even
  OUTPUT_WIDTH 18
  M_DATA_HAS_TREADY true
  HAS_ARESETN true
} {
  S_AXIS_DATA comb_0/M_AXIS
  aclk pll_0/clk_out1
  aresetn slice_0/dout
}

# Create axis_subset_converter
cell xilinx.com:ip:axis_subset_converter subset_0 {
  S_TDATA_NUM_BYTES.VALUE_SRC USER
  M_TDATA_NUM_BYTES.VALUE_SRC USER
  S_TDATA_NUM_BYTES 12
  M_TDATA_NUM_BYTES 8
  TDATA_REMAP {tdata[87:72],tdata[63:48],tdata[39:24],tdata[15:0]}
} {
  S_AXIS fir_0/M_AXIS_DATA
  aclk pll_0/clk_out1
  aresetn slice_0/dout
}

# DMA

# Create xlconstant
cell xilinx.com:ip:xlconstant const_1 {
  CONST_WIDTH 16
  CONST_VAL 65535
}

# Create axis_ram_writer
cell pavel-demin:user:axis_ram_writer writer_0 {
  ADDR_WIDTH 16
  AXI_ID_WIDTH 3
  AXIS_TDATA_WIDTH 64
  FIFO_WRITE_DEPTH 512
} {
  S_AXIS subset_0/M_AXIS
  M_AXI ps_0/S_AXI_ACP
  min_addr slice_3/dout
  cfg_data const_1/dout
  sts_data hub_0/sts_data
  aclk pll_0/clk_out1
  aresetn slice_1/dout
}

# GEN

for {set i 0} {$i <= 1} {incr i} {

  # Create port_slicer
  cell pavel-demin:user:port_slicer slice_[expr $i + 8] {
    DIN_WIDTH 224 DIN_FROM [expr 16 * $i + 207] DIN_TO [expr 16 * $i + 192]
  } {
    din hub_0/cfg_data
  }

  # Create dsp48
  cell pavel-demin:user:dsp48 mult_[expr $i + 4] {
    A_WIDTH 24
    B_WIDTH 16
    P_WIDTH 14
  } {
    A dds_[expr $i + 2]/m_axis_data_tdata
    B slice_[expr $i + 8]/dout
    CLK pll_0/clk_out1
  }

}

# Create xlconcat
cell xilinx.com:ip:xlconcat concat_0 {
  NUM_PORTS 2
  IN0_WIDTH 16
  IN1_WIDTH 16
} {
  In0 mult_4/P
  In1 mult_5/P
  dout dac_0/s_axis_tdata
}
